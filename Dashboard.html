<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRIS - Intelligent Reasoning and Interface System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: #f5f1eb;
            padding: 20px;
            min-height: 100vh;
            color: #2d2d2d;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: left;
            margin-bottom: 32px;
            padding: 32px 40px;
            background: #ffffff;
            border: 1px solid #e0d8cc;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .greeting {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5em;
            font-weight: 600;
            color: #2d2d2d;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .assistant-name {
            font-family: 'Inter', sans-serif;
            font-size: 0.875em;
            color: #ae5630;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .date-time {
            font-size: 0.95em;
            color: #6b6b6b;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0d8cc;
        }

        .system-status {
            display: flex;
            gap: 20px;
            font-size: 0.85em;
            font-family: 'Inter', sans-serif;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b6b6b;
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .card {
            background: #ffffff;
            border: 1px solid #e0d8cc;
            border-radius: 12px;
            padding: 28px 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            transition: box-shadow 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .card h2 {
            font-family: 'Crimson Pro', serif;
            color: #ae5630;
            margin-bottom: 24px;
            font-size: 1.4em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .loading {
            text-align: center;
            color: #ae5630;
            padding: 20px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
        }

        .error {
            color: #c94a2a;
            padding: 12px;
            background: #fef5f2;
            border: 1px solid #f0d4cc;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Inter', sans-serif;
        }

        /* XRP Price Styles */
        .xrp-current {
            font-size: 2.8em;
            font-weight: 600;
            font-family: 'Crimson Pro', serif;
            color: #ae5630;
            margin: 20px 0;
        }

        .xrp-daily-prices {
            margin-top: 24px;
        }

        .xrp-daily-prices h3 {
            font-family: 'Crimson Pro', serif;
            color: #2d2d2d;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .price-day {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            margin: 8px 0;
            background: #faf8f5;
            border-radius: 8px;
            border-left: 3px solid #ae5630;
            transition: background 0.2s ease;
        }

        .price-day:hover {
            background: #f5f1eb;
        }

        .price-day .date {
            font-weight: 500;
            color: #2d2d2d;
            font-family: 'Inter', sans-serif;
        }

        .price-day .price {
            color: #ae5630;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .stat-box {
            background: #faf8f5;
            border: 1px solid #e0d8cc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: background 0.2s ease;
        }

        .stat-box:hover {
            background: #f5f1eb;
        }

        .stat-label {
            font-size: 0.85em;
            color: #6b6b6b;
            margin-bottom: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #2d2d2d;
            font-family: 'Crimson Pro', serif;
        }

        /* Weather Styles */
        .weather-location {
            margin-bottom: 30px;
        }

        .weather-location h3 {
            font-family: 'Crimson Pro', serif;
            color: #2d2d2d;
            margin-bottom: 16px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .current-weather {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 24px;
            padding: 24px;
            background: #faf8f5;
            border: 1px solid #e0d8cc;
            border-radius: 10px;
        }

        .weather-icon {
            font-size: 4em;
        }

        .current-temp {
            font-size: 3em;
            font-weight: 600;
            font-family: 'Crimson Pro', serif;
            color: #ae5630;
        }

        .weather-details {
            flex: 1;
        }

        .weather-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0d8cc;
            color: #6b6b6b;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
        }

        .weather-detail:last-child {
            border-bottom: none;
        }

        .weather-detail strong {
            color: #2d2d2d;
            font-weight: 600;
        }

        .forecast-days {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 16px;
        }

        .forecast-day {
            background: #faf8f5;
            border: 1px solid #e0d8cc;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            transition: background 0.2s ease;
        }

        .forecast-day:hover {
            background: #f5f1eb;
        }

        .forecast-day .day-name {
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            color: #6b6b6b;
            margin-bottom: 8px;
            font-size: 0.85em;
        }

        .forecast-day .temp {
            color: #ae5630;
            font-weight: 600;
            font-size: 1.2em;
            font-family: 'Crimson Pro', serif;
        }

        .forecast-day .weather-desc {
            font-size: 0.8em;
            color: #6b6b6b;
            margin-top: 6px;
            font-family: 'Inter', sans-serif;
        }

        .refresh-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #ffffff;
            border: 1px solid #e0d8cc;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 1.4em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            color: #ae5630;
        }

        .refresh-button:hover {
            transform: rotate(90deg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #ae5630;
        }

        .last-updated {
            text-align: center;
            color: #6b6b6b;
            margin-top: 24px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85em;
        }

        .nav-button {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: #ffffff;
            border: 1px solid #e0d8cc;
            border-radius: 8px;
            padding: 12px 20px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            color: #ae5630;
            text-decoration: none;
            display: block;
            text-align: center;
        }

        .nav-button:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #ae5630;
            background: #faf8f5;
        }

        /* News Feed Styles */
        .news-feed {
            margin-top: 20px;
        }

        .news-item {
            background: #faf8f5;
            border-left: 3px solid #ae5630;
            padding: 18px 20px;
            margin: 12px 0;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .news-item:hover {
            background: #f5f1eb;
        }

        .news-item a {
            color: #2d2d2d;
            text-decoration: none;
            display: block;
        }

        .news-item a:hover .news-title {
            color: #ae5630;
        }

        .news-title {
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 10px;
            line-height: 1.5;
            font-family: 'Crimson Pro', serif;
            transition: color 0.2s ease;
        }

        .news-meta {
            display: flex;
            gap: 12px;
            font-size: 0.85em;
            color: #6b6b6b;
            font-family: 'Inter', sans-serif;
            margin-bottom: 8px;
        }

        .news-source {
            font-weight: 500;
        }

        .news-date {
            color: #999;
        }

        .news-description {
            font-size: 0.9em;
            color: #6b6b6b;
            line-height: 1.6;
            margin-top: 8px;
            font-family: 'Inter', sans-serif;
        }

        .news-category {
            display: inline-block;
            background: #f0e8dd;
            color: #ae5630;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 2em;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="assistant-name">I.R.I.S. | Intelligent Reasoning and Interface System</div>
            <div class="greeting" id="greeting">Good Morning, Zack</div>
            <div class="date-time" id="currentDateTime"></div>
            <div class="status-bar">
                <div class="system-status">
                    <div class="status-item">
                        <div class="status-indicator"></div>
                        <span>All Systems Online</span>
                    </div>
                    <div class="status-item">
                        <div class="status-indicator"></div>
                        <span>Data Sync Active</span>
                    </div>
                    <div class="status-item">
                        <div class="status-indicator"></div>
                        <span>Real-time Updates</span>
                    </div>
                </div>
                <div id="systemTime" style="font-family: 'Orbitron', sans-serif; color: #00b7ff;"></div>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- XRP Price Card -->
            <div class="card">
                <h2>üíé XRP Market Analytics</h2>
                <div id="xrpContent">
                    <div class="loading">Initializing market data feed</div>
                </div>
            </div>

            <!-- Irving Weather Card -->
            <div class="card">
                <h2>üå°Ô∏è Irving Climate</h2>
                <div id="irvingWeather">
                    <div class="loading">Scanning atmospheric conditions</div>
                </div>
            </div>

            <!-- Lewisville Weather Card -->
            <div class="card">
                <h2>üå°Ô∏è Lewisville Climate</h2>
                <div id="lewisvilleWeather">
                    <div class="loading">Scanning atmospheric conditions</div>
                </div>
            </div>
        </div>

        <!-- News Feed Section (Full Width) -->
        <div class="card" style="margin-top: 20px;">
            <h2>üì∞ Intelligence Feed</h2>
            <div id="newsContent">
                <div class="loading">Aggregating news intelligence</div>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated"></div>
    </div>

    <a href="/tech-news" class="nav-button">üöÄ Tech News</a>
    <button class="refresh-button" onclick="requestRefresh()" title="Refresh Data">&#8635;</button>

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        // Configuration
        let config = {
            userName: 'User',
            primaryCity: 'Irving',
            secondaryCity: 'Lewisville'
        };

        // WebSocket connection
        let socket = null;
        let connectionStatus = 'disconnected';

        // Initialize WebSocket connection
        function initializeWebSocket() {
            // Try to connect to localhost first, fallback to current host
            const socketUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:8080'
                : window.location.origin;

            socket = io(socketUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: Infinity
            });

            socket.on('connect', () => {
                console.log('WebSocket Connected to IRIS Backend');
                connectionStatus = 'connected';
                updateConnectionStatus();
            });

            socket.on('disconnect', () => {
                console.log('WebSocket Disconnected');
                connectionStatus = 'disconnected';
                updateConnectionStatus();
            });

            socket.on('dashboard_update', (data) => {
                console.log('Received dashboard update from server');
                handleDashboardUpdate(data);
            });

            socket.on('connect_error', (error) => {
                console.error('WebSocket connection error:', error);
                connectionStatus = 'error';
                updateConnectionStatus();
            });
        }

        function updateConnectionStatus() {
            const statusItems = document.querySelectorAll('.status-item');
            if (statusItems.length > 1) {
                const dataSyncItem = statusItems[1];
                const indicator = dataSyncItem.querySelector('.status-indicator');
                const text = dataSyncItem.querySelector('span');

                if (connectionStatus === 'connected') {
                    indicator.style.background = '#22c55e';
                    text.textContent = 'Live Data Stream Active';
                } else if (connectionStatus === 'error') {
                    indicator.style.background = '#c94a2a';
                    text.textContent = 'Connection Error';
                } else {
                    indicator.style.background = '#d4a574';
                    text.textContent = 'Connecting...';
                }
            }
        }

        // Update current date and time with personalized greeting
        function updateDateTime() {
            const now = new Date();
            const hour = now.getHours();

            // Personalized greeting based on time
            let greeting = 'Good Evening';
            if (hour < 12) {
                greeting = 'Good Morning';
            } else if (hour < 18) {
                greeting = 'Good Afternoon';
            }

            document.getElementById('greeting').textContent = `${greeting}, ${config.userName}`;

            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);

            // Update system time
            const timeString = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('systemTime').textContent = timeString;
        }

        // Handle dashboard data update from WebSocket
        function handleDashboardUpdate(data) {
            if (data.xrp) {
                displayXRPData(data.xrp);
            }
            if (data.weather) {
                if (data.weather.irving) {
                    displayWeatherData(data.weather.irving, 'irvingWeather');
                }
                if (data.weather.lewisville) {
                    displayWeatherData(data.weather.lewisville, 'lewisvilleWeather');
                }
            }
            if (data.news) {
                displayNewsData(data.news);
            }

            // Update last updated time
            const now = new Date();
            document.getElementById('lastUpdated').textContent =
                `SYSTEM STATUS: Data synchronized at ${now.toLocaleTimeString('en-US')}`;
        }

        // Display XRP data
        function displayXRPData(xrpData) {
            const container = document.getElementById('xrpContent');
            const currentPrice = xrpData.current_price;
            const change24h = xrpData.change_24h;
            const marketCap = xrpData.market_cap;
            const dailyAverages = xrpData.daily_averages;

            let html = `
                <div class="xrp-current">$${currentPrice.toFixed(4)}</div>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-label">24h Change</div>
                        <div class="stat-value" style="color: ${change24h >= 0 ? '#ae5630' : '#c94a2a'}">
                            ${change24h >= 0 ? '+' : ''}${change24h.toFixed(2)}%
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Market Cap</div>
                        <div class="stat-value">$${(marketCap / 1e9).toFixed(2)}B</div>
                    </div>
                </div>
                <div class="xrp-daily-prices">
                    <h3>7-Day Market Analysis</h3>
            `;

            dailyAverages.forEach(day => {
                html += `
                    <div class="price-day">
                        <span class="date">${day.date}</span>
                        <span class="price">$${day.avgPrice.toFixed(4)}</span>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Display weather data
        function displayWeatherData(weatherData, elementId) {
            const container = document.getElementById(elementId);

            // Weather code to description mapping
            const weatherCodes = {
                    0: 'Clear sky',
                    1: 'Mainly clear',
                    2: 'Partly cloudy',
                    3: 'Overcast',
                    45: 'Foggy',
                    48: 'Foggy',
                    51: 'Light drizzle',
                    53: 'Moderate drizzle',
                    55: 'Dense drizzle',
                    61: 'Slight rain',
                    63: 'Moderate rain',
                    65: 'Heavy rain',
                    71: 'Slight snow',
                    73: 'Moderate snow',
                    75: 'Heavy snow',
                    77: 'Snow grains',
                    80: 'Slight showers',
                    81: 'Moderate showers',
                    82: 'Violent showers',
                    85: 'Slight snow showers',
                    86: 'Heavy snow showers',
                    95: 'Thunderstorm',
                    96: 'Thunderstorm with hail',
                    99: 'Thunderstorm with hail'
                };

                const weatherIcons = {
                    0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
                    45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                    51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è',
                    61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: '‚õàÔ∏è',
                    71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: '‚ùÑÔ∏è', 77: '‚ùÑÔ∏è',
                    80: 'üå¶Ô∏è', 81: 'üåßÔ∏è', 82: '‚õàÔ∏è',
                    85: 'üå®Ô∏è', 86: 'üå®Ô∏è',
                    95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
                };

            const currentWeather = weatherData.current;
            const currentCode = currentWeather.weather_code;
            const dailyData = weatherData.daily;

            let html = `
                <div class="current-weather">
                    <div class="weather-icon">${weatherIcons[currentCode] || 'üå°Ô∏è'}</div>
                    <div>
                        <div class="current-temp">${Math.round(currentWeather.temperature_2m)}¬∞F</div>
                        <div style="color: #b0b0b0; font-size: 1.1em;">${weatherCodes[currentCode] || 'Unknown'}</div>
                    </div>
                </div>
                <div class="weather-details">
                    <div class="weather-detail">
                        <span>Feels Like</span>
                        <strong>${Math.round(currentWeather.apparent_temperature)}¬∞F</strong>
                    </div>
                    <div class="weather-detail">
                        <span>Humidity</span>
                        <strong>${currentWeather.relative_humidity_2m}%</strong>
                    </div>
                    <div class="weather-detail">
                        <span>Wind Speed</span>
                        <strong>${Math.round(currentWeather.wind_speed_10m)} mph</strong>
                    </div>
                    <div class="weather-detail">
                        <span>Precipitation</span>
                        <strong>${currentWeather.precipitation} in</strong>
                    </div>
                </div>
                <h4 style="margin-top: 20px; margin-bottom: 10px; color: #2d2d2d; font-family: 'Crimson Pro', serif; font-size: 1.1em; font-weight: 600;">7-Day Forecast Analysis</h4>
                <div class="forecast-days">
            `;

            // Add forecast days
            for (let i = 0; i < 7; i++) {
                const date = new Date(dailyData.time[i]);
                const dayName = i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
                const maxTemp = Math.round(dailyData.temperature_2m_max[i]);
                const minTemp = Math.round(dailyData.temperature_2m_min[i]);
                const weatherCode = dailyData.weather_code[i];

                html += `
                    <div class="forecast-day">
                        <div class="day-name">${dayName}</div>
                        <div style="font-size: 2em; margin: 10px 0;">${weatherIcons[weatherCode] || 'üå°Ô∏è'}</div>
                        <div class="temp">${maxTemp}¬∞ / ${minTemp}¬∞</div>
                        <div class="weather-desc">${weatherCodes[weatherCode] || 'Unknown'}</div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Display news data
        function displayNewsData(newsData) {
            const container = document.getElementById('newsContent');

            if (!newsData || newsData.length === 0) {
                container.innerHTML = '<div style="color: #b0b0b0; text-align: center; padding: 20px;">No news articles available</div>';
                return;
            }

            let html = '<div class="news-feed">';

            newsData.forEach(article => {
                const publishedDate = new Date(article.publishedAt);
                const timeAgo = getTimeAgo(publishedDate);

                html += `
                    <div class="news-item">
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer">
                            <div class="news-meta">
                                ${article.category ? `<span class="news-category">${article.category}</span>` : ''}
                                <span class="news-source">${article.source}</span>
                                <span class="news-date">${timeAgo}</span>
                            </div>
                            <div class="news-title">${article.title}</div>
                            ${article.description ? `<div class="news-description">${article.description}</div>` : ''}
                        </a>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Helper function to calculate time ago
        function getTimeAgo(date) {
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Request manual refresh from server
        function requestRefresh() {
            if (socket && socket.connected) {
                // send a force flag to ensure server fetches fresh XRP data
                socket.emit('request_refresh', { force: true });
                console.log('Manual refresh requested (force=true)');
            } else {
                console.warn('WebSocket not connected, cannot refresh');
            }
        }

        // Update date/time every second for real-time feel
        setInterval(updateDateTime, 1000);

        // Fetch configuration from server
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                if (response.ok) {
                    config = await response.json();
                    console.log('Configuration loaded:', config);
                }
            } catch (error) {
                console.warn('Could not load config, using defaults:', error);
            }
        }

        // Initial load with welcome message
        async function initialize() {
            await loadConfig();
            console.log('IRIS - Intelligent Reasoning and Interface System Initialized');
            console.log(`Welcome, ${config.userName}. All systems are online and operational.`);
            initializeWebSocket();
            updateDateTime();
        }

        // Start initialization
        initialize();
    </script>
</body>
</html>
